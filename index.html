<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thommysax</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<div data-include="headbar"></div>

  <!-- MAIN -->
  <main class="main">

      <!-- HERO (Bild oben, Text darunter) -->
  <section class="hero">
    <div class="hero__media">
      <img src="Resources/TitlePic.png" alt="Thommysax live" />
    </div>

    <div class="hero__below">
      <div class="container">
        <p class="hero__kicker">Live-Sax f√ºr Events, Hochzeiten & Firmenfeiern</p>
        <h1 class="hero__title">THOMMYSAX</h1>
        <p class="hero__text" id="TitleText">L√§dt Text‚Ä¶</p>

        <div class="hero__cta">
          <a class="btn btn--primary" href="contact.html">Jetzt Anfragen!</a>
        </div>
      </div>
    </div>
  </section>
    <section class="section" id="events">
      <div class="container">
        <header class="section__head">
          <h2 class="section__title">Events</h2>
          <p class="section__sub">Alle √∂ffentlichen Termine auf einen Blick.</p>
        </header>

        <div class="panel">
          <div class="panel__top">
            <div class="panel__title">Kommende Termine</div>
            <div class="panel__meta" id="eventsMeta">L√§dt‚Ä¶</div>
          </div>

          <div class="events" id="eventsList"></div>
        </div>
      </div>
    </section>
  </main>

<div data-include="footbar"></div>

<script src="Fixedpages/include.js"></script>

<script>
  // globales, delegiertes Binding (funktioniert auch wenn headbar erst sp√§ter kommt)
  bindHeadbarOnce();
</script>


<script>
function loadTitleText(){
  const el = document.getElementById("TitleText");
  if (!el) return false;

  fetch("Texts/TitleText.txt", { cache: "no-store" })
    .then(r => r.ok ? r.text() : Promise.reject(new Error("TitleText 404")))
    .then(t => el.innerHTML = t.trim().split("\n").map(l => l.trim()).join("<br>"))
    .catch(() => el.textContent = "Text konnte nicht geladen werden.");

  return true;
}

document.addEventListener("DOMContentLoaded", () => {
  if (loadTitleText()) return;

  // falls #TitleText erst durch include kommt: kurz pollen
  let tries = 0;
  const t = setInterval(() => {
    tries++;
    if (loadTitleText() || tries > 60) clearInterval(t);
  }, 50);
});
</script>



  <script>
    // Events (JSONP)
    const EVENTS_API = "https://script.google.com/macros/s/AKfycbwkAFz-5pvzWuR79_A6UfA6vEhIgdrL1h5Hd8pRndlsl__KhOn6nfdXuinerKw0LaPQAg/exec";
    const EVENTS_DAYS = 180;
    const EVENTS_MAX  = 40;
    const PUBLIC_ONLY = 0;

    function loadJSONP(url, timeoutMs = 10000) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("JSONP timeout"));
        }, timeoutMs);

        window[cb] = (data) => {
          clearTimeout(timer);
          cleanup();
          resolve(data);
        };

        const join = url.includes("?") ? "&" : "?";
        s.src = `${url}${join}callback=${cb}&_=${Date.now()}`;
        s.async = true;
        s.onerror = () => {
          clearTimeout(timer);
          cleanup();
          reject(new Error("JSONP load error"));
        };

        document.head.appendChild(s);

        function cleanup() {
          try { delete window[cb]; } catch {}
          s.remove();
        }
      });
    }

    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));

    const fmtDate = (d) => new Intl.DateTimeFormat("de-DE", {
      weekday:"short", day:"2-digit", month:"2-digit", year:"numeric"
    }).format(d);

    const fmtTime = (d) => new Intl.DateTimeFormat("de-DE", {
      hour:"2-digit", minute:"2-digit"
    }).format(d);

    function renderEvents(payload){
      const list = document.getElementById("eventsList");
      const meta = document.getElementById("eventsMeta");

      if (!payload || payload.ok !== true) {
        meta.textContent = "Fehler";
        list.innerHTML = `<div class="events__empty">Events konnten nicht geladen werden.</div>`;
        return;
      }

      const events = payload.events || [];
      meta.textContent = events.length ? `${events.length} Termine` : "Keine Termine";

      if (!events.length) {
        list.innerHTML = `<div class="events__empty">Aktuell keine Termine.</div>`;
        return;
      }

      list.innerHTML = events.map(ev => {
        const s = new Date(ev.start);
        const e = new Date(ev.end);
        const dateStr = fmtDate(s);
        const timeStr = ev.allDay ? "Ganzt√§gig" : `${fmtTime(s)} ‚Äì ${fmtTime(e)}`;
        const loc = ev.location ? ev.location : "";

        return `
          <article class="event">
            <div class="event__top">
              <div class="event__date">${esc(dateStr)}</div>
              <div class="event__time">${esc(timeStr)}</div>
            </div>
            <div class="event__title">${esc(ev.title || "Ohne Titel")}</div>
            ${loc ? `<div class="event__sub">üìç ${esc(loc)}</div>` : ``}
          </article>
        `;
      }).join("");
    }

    (async function(){
      const url = `${EVENTS_API}?days=${EVENTS_DAYS}&max=${EVENTS_MAX}&publicOnly=${PUBLIC_ONLY}`;
      try {
        const data = await loadJSONP(url);
        renderEvents(data);
      } catch (err) {
        console.error(err);
        renderEvents({ ok:false });
      }
    })();
  </script>

</body>
</html>
